<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard - Cartify</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #ffffff;
    }
    header {
      background-color: #ffffff;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header h1 {
      font-style: italic;
      color: #007bff;
      margin: 0;
    }
    .top-right {
      display: flex;
      gap: 12px;
      position: relative;
    }
    .top-right button {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .logout-btn {
      background-color: #dc3545;
      color: white;
    }
    .profile-btn {
      background-color: #007bff;
      color: white;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 38px;
      right: 70px;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border-radius: 6px;
      min-width: 150px;
      z-index: 1000;
    }
    .dropdown-content a {
      padding: 10px 14px;
      display: block;
      text-decoration: none;
      color: #333;
    }
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
    #profileModal {
      display: none;
      position: absolute;
      top: 50px;
      right: 100px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 300px;
      z-index: 999;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
    }
    h2 {
      margin-bottom: 15px;
    }
    #uploadToggle {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 5px;
      cursor: pointer;
    }
    #uploadForm {
      margin-top: 15px;
      display: none;
      background: #f1f1f1;
      padding: 20px;
      border-radius: 6px;
    }
    #uploadForm input, #uploadForm textarea {
      display: block;
      margin-bottom: 12px;
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #uploadForm button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 5px;
      cursor: pointer;
    }
    .product-list {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 30px;
    }
    .product-card {
      width: calc(33.333% - 15px);
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .product-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .review-section {
      margin-top: 8px;
      background: #f9f9f9;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    canvas {
      margin-top: 40px;
      max-width: 100%;
    }
    #leastOrderedChart {
      max-width: 800px;
      max-height: 800px;
      margin: 1 auto;
      display: block;
    }
    #mostOrderedChart {
      max-width: 600px;
      margin: 1 auto;
      display: block;
    }
    @media (max-width: 768px) {
      .product-card {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div id="toast" style="
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;    /* ← move to the left */
  background: #28a745;
  color: white;
  padding: 10px 16px;
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 10000;
"></div>

<header>
  <h1>Cartify</h1>
  <div class="top-right">
    <div class="dropdown">
      <button class="profile-btn" onclick="toggleDropdown()">👤 Profile</button>
      <div id="dropdownMenu" class="dropdown-content">
        <a href="#" onclick="viewProfile()">View Profile</a>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  <h2>Welcome Seller!</h2>

<div id="balanceSection" style="margin: 20px 0; padding: 15px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 8px;">
  <div style="display: flex; justify-content: flex-end;">
    <div style="text-align: right;">
      <h3>💰 Your Balance</h3>
      <p><strong>Available Balance:</strong> $<span id="availableBalance">0.00</span></p>
      <p><strong>Pending Balance:</strong> $<span id="pendingBalance">0.00</span></p>
      <button onclick="openWithdrawModal()" style="padding: 10px 20px; background-color: #ffc107; color: #000; border: none; border-radius: 6px; cursor: pointer;">Withdraw</button>
    </div>
  </div>
</div>

  <button id="uploadToggle" onclick="toggleUpload()">+ Upload Product</button>
  <form id="uploadForm" onsubmit="uploadProduct(event)">
    <input type="text" id="name" placeholder="Product Name" required />
    <input type="number" id="price" placeholder="Price" required />
    <input type="text" id="category" placeholder="Category" />
    <input type="number" id="stock" placeholder="Stock" />
    <textarea id="description" placeholder="Description"></textarea>
    <input type="file" id="image" accept="image/*" required />
    <button type="submit">Submit</button>
  </form>

  <div style="display: flex; gap: 20px; margin-top: 40px;">
    <button onclick="showProducts()" style="background:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">Your Products</button>
    <button onclick="showOrders()" style="background:#28a745;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">Your Orders</button>
    <button onclick="showDisputes()" style="background:#dc3545;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">Disputes</button>
  </div>
  <div id="productSection">
  <div id="filterBox" style="margin: 20px 0; display: flex; gap: 12px; flex-wrap: wrap;">
  <input type="text" id="filterName" placeholder="Search name..." style="padding: 6px;" />
  <input type="number" id="filterMinPrice" placeholder="Min price" style="padding: 6px; width: 100px;" />
  <input type="number" id="filterMaxPrice" placeholder="Max price" style="padding: 6px; width: 100px;" />
  <input type="number" id="filterMinStock" placeholder="Min stock" style="padding: 6px; width: 100px;" />
  <input type="number" id="filterMaxStock" placeholder="Max stock" style="padding: 6px; width: 100px;" />
  <button onclick="applyProductFilters()" style="padding: 6px 12px; background-color:#007bff; color:white; border:none; border-radius:4px;">Apply Filters</button>
</div>

    <div class="product-list" id="productList"></div>
    <p id="noProductsMsg" style="margin-top: 15px; font-style: italic; display: none;">You haven't listed any products yet.</p>
  </div>
  <div id="orderSection" style="display:none;">
    <h2>Your Orders</h2>
    <div id="orderList">Loading orders...</div>
  </div>
  <div id="disputeSection" style="display:none; margin-top: 30px;">
    <h2>🛑 Buyer Disputes</h2>
    <div id="sellerDisputeList">Loading disputes...</div>
  </div>
  <h2>📊 Dashboard</h2>
   <div id="statsSummary" style="margin-bottom: 30px;">
  <h3>📈 Sales Summary</h3>
  <p><strong>Total Products Sold:</strong> <span id="soldCount">0</span></p>
  <p><strong>Total Revenue:</strong> $<span id="revenueAmount">0.00</span></p>
</div>
 <div class="chart-row"></div>
  <canvas id="mostOrderedChart" height="200"></canvas>
  <canvas id="leastOrderedChart" height="200"></canvas>
 </div>
</div>

<div id="profileModal">
  <h3>Your Profile</h3>
  <form id="profileForm" onsubmit="updateProfile(event)">
    <div style="display:flex; flex-direction:column; gap:10px;">
      <input type="email" id="profileEmail" placeholder="Email" disabled />
      <input type="text" id="profileCountry" placeholder="Country" disabled />
      <input type="text" id="profileState" placeholder="State" disabled />
      <input type="text" id="profileCity" placeholder="City" disabled />
      <input type="text" id="profileAddress1" placeholder="Address Line 1" disabled />
      <input type="text" id="profileAddress2" placeholder="Address Line 2" disabled />
      <div style="display:flex; gap:10px;">
        <button type="button" onclick="enableEdit()">Edit</button>
        <button type="submit">Update</button>
        <button type="button" onclick="closeProfile()">Close</button>
      </div>
    </div>
  </form>
</div>

<div id="editModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:1000; width:350px;">
  <h3>Edit Product</h3>
  <form id="editForm" onsubmit="submitEdit(event)">
    <input type="hidden" id="editId" />
    <input type="text" id="editName" placeholder="Name" required />
    <input type="number" id="editPrice" placeholder="Price" required />
    <input type="text" id="editCategory" placeholder="Category" />
    <input type="number" id="editStock" placeholder="Stock" />
    <textarea id="editDescription" placeholder="Description"></textarea>
    <input type="file" id="editImage" accept="image/*" />
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button type="submit">Update</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script>
let mostChart = null;
let leastChart = null;
function logout() {
  localStorage.clear();
  location.href = 'login.html';
}
function toggleUpload() {
  const form = document.getElementById('uploadForm');
  form.style.display = form.style.display === 'block' ? 'none' : 'block';
}
function toggleDropdown() {
  const menu = document.getElementById("dropdownMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}
window.onclick = function(e) {
  if (!e.target.matches('.profile-btn')) {
    const dropdown = document.getElementById("dropdownMenu");
    if (dropdown && dropdown.style.display === "block") {
      dropdown.style.display = "none";
    }
  }
}

function showToast(message) {
  const t = document.getElementById("toast");
  t.textContent = message;
  t.style.display = "block";
  setTimeout(() => { t.style.display = "none"; }, 3000);
}

function viewProfile() {
  fetch('/api/users/me', {
    headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
  })
  .then(res => res.json())
  .then(user => {
    document.getElementById('profileEmail').value = user.email || '';
    document.getElementById('profileCountry').value = user.country || '';
    document.getElementById('profileState').value = user.state || '';
    document.getElementById('profileCity').value = user.city || '';
    document.getElementById('profileAddress1').value = user.address1 || '';
    document.getElementById('profileAddress2').value = user.address2 || '';
    disableFields();
    document.getElementById('profileModal').style.display = 'block';
  });
}
function enableEdit() {
  ['profileEmail','profileCountry','profileState','profileCity','profileAddress1','profileAddress2']
    .forEach(id => document.getElementById(id).disabled = false);
}
function disableFields() {
  ['profileEmail','profileCountry','profileState','profileCity','profileAddress1','profileAddress2']
    .forEach(id => document.getElementById(id).disabled = true);
}
function closeProfile() {
  document.getElementById('profileModal').style.display = 'none';
}
function updateProfile(e) {
  e.preventDefault();
  const updated = {
    email: document.getElementById('profileEmail').value,
    country: document.getElementById('profileCountry').value,
    state: document.getElementById('profileState').value,
    city: document.getElementById('profileCity').value,
    address1: document.getElementById('profileAddress1').value,
    address2: document.getElementById('profileAddress2').value
  };
  fetch('/api/users/me', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + localStorage.getItem('token')
    },
    body: JSON.stringify(updated)
  })
  .then(res => res.json())
  .then(() => {
    alert('Profile updated!');
    disableFields();
    closeProfile();
  })
  .catch(() => alert('Update failed'));
}

function getUserId() {
  return localStorage.getItem('userId') || '';
}

async function loadProducts() {
  const res = await fetch('/api/products');
  const all = await res.json();

  const myProducts = all.filter(p => p.seller === getUserId());

  // 🔍 Apply filters
  const nameFilter = document.getElementById('filterName')?.value.toLowerCase() || '';
  const minPrice = parseFloat(document.getElementById('filterMinPrice')?.value) || 0;
  const maxPrice = parseFloat(document.getElementById('filterMaxPrice')?.value) || Infinity;
  const minStock = parseInt(document.getElementById('filterMinStock')?.value) || 0;
  const maxStock = parseInt(document.getElementById('filterMaxStock')?.value) || Infinity;

  const filtered = myProducts.filter(p =>
    (!nameFilter || p.name.toLowerCase().includes(nameFilter)) &&
    (p.price >= minPrice && p.price <= maxPrice) &&
    (p.stock >= minStock && p.stock <= maxStock)
  );

  const container = document.getElementById('productList');
  container.innerHTML = '';
  document.getElementById('noProductsMsg').style.display = filtered.length === 0 ? 'block' : 'none';

  for (const p of filtered) {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <img src="${p.image || 'https://dummyimage.com/300x150/cccccc/000000&text=No+Image'}" />
      <h4>${p.name}</h4>
      <p><strong>Price:</strong> $${p.price}</p>
      <p><strong>Description:</strong> ${p.description || 'No description provided.'}</p>
      <button onclick="loadReviews('${p._id}', this)">💬 View Reviews</button>
      <button onclick='openEditModal(${JSON.stringify(p)})'>✏️ Edit</button>
      <button onclick='deleteProduct("${p._id}")'>🗑️ Remove</button>
      <div class="review-section" id="review-${p._id}"></div>
    `;
    container.appendChild(card);
  }
}

function applyProductFilters() {
  loadProducts();
}

async function loadReviews(productId) {
  const container = document.getElementById(`review-${productId}`);
  if (container.style.display === 'block') {
    container.style.display = 'none';
    return;
  }
  const res = await fetch(`/api/reviews/product/${productId}`);
  const reviews = await res.json();
  container.innerHTML = reviews.length === 0 ? '<p>No reviews yet.</p>' :
    reviews.map(r => `<p><strong>${r.user.name}:</strong> ${r.comment}</p>`).join('');
  container.style.display = 'block';
}

async function loadChart() {
  const res = await fetch('/api/orders/by-product', {
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`
    }
  });
  const data = await res.json();
  if (!Array.isArray(data)) return;

  const sorted = [...data].sort((a, b) => b.totalSold - a.totalSold);
  const most = sorted.slice(0, 5);
  let least = sorted.slice(-5);

  const allZero = least.every(p => p.totalSold === 0);
  if (least.length === 0 || allZero) {
    least = [{ name: "No Sales Yet", totalSold: 1 }];
  }

  // 🧨 Destroy previous charts if they exist
  if (mostChart) mostChart.destroy();
  if (leastChart) leastChart.destroy();

  const ctx1 = document.getElementById('mostOrderedChart').getContext('2d');
  mostChart = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: most.map(p => p.name),
      datasets: [{
        label: 'Top Products (Units Sold)',
        data: most.map(p => p.totalSold),
        backgroundColor: '#007bff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Most Ordered Products' }
      }
    }
  });

  const ctx2 = document.getElementById('leastOrderedChart').getContext('2d');
  leastChart = new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: least.map(p => p.name),
      datasets: [{
        label: 'Least Ordered',
        data: least.map(p => p.totalSold),
        backgroundColor: least.length === 1 && least[0].name === 'No Sales Yet'
          ? ['#cccccc']
          : ['#ff6384', '#ff9f40', '#ffcd56', '#4bc0c0', '#36a2eb']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Least Ordered Products' }
      }
    }
  });
}

async function uploadProduct(e) {
  e.preventDefault();
  const formData = new FormData();
  formData.append('name', document.getElementById('name').value);
  formData.append('price', document.getElementById('price').value);
  formData.append('category', document.getElementById('category').value);
  formData.append('stock', document.getElementById('stock').value);
  formData.append('description', document.getElementById('description').value);
  formData.append('image', document.getElementById('image').files[0]);

  const res = await fetch('/api/products/upload', {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`
    },
    body: formData
  });

  if (res.ok) {
    alert('✅ Product uploaded!');
    document.getElementById('uploadForm').reset();
    loadProducts();
  } else {
    const err = await res.json();
    alert('❌ Upload failed: ' + (err.error || 'Unknown error'));
  }
}

loadProducts();

loadChart();

// ✏️ Add edit/remove functions here 👇
function openEditModal(product) {
  document.getElementById('editId').value = product._id;
  document.getElementById('editName').value = product.name;
  document.getElementById('editPrice').value = product.price;
  document.getElementById('editCategory').value = product.category || '';
  document.getElementById('editStock').value = product.stock || '';
  document.getElementById('editDescription').value = product.description || '';
  document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  document.getElementById('editForm').reset();
}

async function submitEdit(e) {
  e.preventDefault(); // 👈 Fix: prevent form reload
  const productId = document.getElementById('editId').value; // 👈 Fix: get ID here

  const formData = new FormData();
  formData.append('name', document.getElementById('editName').value);
  formData.append('price', document.getElementById('editPrice').value);
  formData.append('category', document.getElementById('editCategory').value);
  formData.append('stock', document.getElementById('editStock').value);
  formData.append('description', document.getElementById('editDescription').value);

  const fileInput = document.getElementById('editImage');
  if (fileInput.files.length > 0) {
    formData.append('image', fileInput.files[0]);
  }

  const res = await fetch(`/api/products/${productId}`, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`
    },
    body: formData
  });

  if (res.ok) {
    alert('✅ Product updated!');
    closeEditModal();
    loadProducts();
  } else {
    const err = await res.json();
    alert('❌ Failed to update product: ' + (err.error || 'Unknown error'));
  }
}

async function deleteProduct(id) {
  if (!confirm("Are you sure you want to delete this product?")) return;
  const res = await fetch(`/api/products/${id}`, {
    method: 'DELETE',
    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
  });
  if (res.ok) {
    alert("🗑️ Product deleted.");
    loadProducts();
  } else {
    alert("❌ Failed to delete.");
  }
}

 (async function initDashboard() {
    await loadProducts();
    await loadSellerBalance();

    const summaryRes = await fetch('/api/orders/seller/summary', {
      headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
    });
    const summary = await summaryRes.json();
    document.getElementById('soldCount').textContent = summary.totalSold || '0';
    document.getElementById('revenueAmount').textContent = summary.totalRevenue ? summary.totalRevenue.toFixed(2) : '0.00';

    await loadChart();
  })();

  function showProducts() {
  document.getElementById('productSection').style.display = 'block';
  document.getElementById('orderSection').style.display = 'none';
}

function showOrders() {
  document.getElementById('productSection').style.display = 'none';
  document.getElementById('orderSection').style.display = 'block';
  loadOrders(); // Load orders dynamically
}

function showDisputes() {
  document.getElementById("productSection").style.display = "none";
  document.getElementById("orderSection").style.display = "none";
  document.getElementById("disputeSection").style.display = "block";
  loadSellerDisputes();
}

// —————— REPLACE your old loadSellerDisputes() with this ——————
async function loadSellerDisputes() {
  const token = localStorage.getItem("token");
  let disputes;
  try {
    const res = await fetch("/api/disputes/for-seller", {
      headers: { Authorization: `Bearer ${token}` }
    });
    disputes = await res.json();
  } catch (err) {
    console.error("Error loading disputes:", err);
    return document.getElementById("sellerDisputeList")
             .innerHTML = "<p>Error loading disputes.</p>";
  }

  const container = document.getElementById("sellerDisputeList");
  container.innerHTML = "";
  if (!disputes.length) {
    return container.innerHTML = "<p>No disputes found.</p>";
  }

  disputes.forEach(d => {
    // 1️⃣ Build a unified history array
    const history = [];

    // — Original opening (old top‐level)
    if (d.message) {
      history.push({
        author: "buyer",
        message: d.message,
        file:    d.file || null,
        createdAt: d.createdAt
      });
    }

    // — Old one‐time seller response
    if (d.response) {
      history.push({
        author: "seller",
        message: d.response,
        file:    d.sellerFile || null,
        // if you stored an updatedAt, use it; else fallback to createdAt
        createdAt: d.updatedAt || d.createdAt
      });
    }

    // — All threaded replies (new style)
    (d.replies || []).forEach(r => history.push(r));

    // 2️⃣ Sort by date
    history.sort((a, b) =>
      new Date(a.createdAt) - new Date(b.createdAt)
    );

    // 3️⃣ Render HTML for every entry
    const historyHtml = history.map(r => `
      <div style="margin:8px 0; padding:8px; border:1px solid #ddd; border-radius:4px;">
        <p>
          <strong>${r.author === "buyer" ? "Buyer" : "You"}:</strong>
          ${r.message}
        </p>
        ${r.file
          ? `<p><a href="${r.file}" target="_blank">📎 Attachment</a></p>`
          : ""}
        <small>${new Date(r.createdAt).toLocaleString()}</small>
      </div>
    `).join("");

    // 4️⃣ Inline follow-up box when last author was buyer & not resolved
    const last = history[history.length - 1];
    const showForm = last?.author === "buyer" && !d.resolved;
    const followUpForm = showForm ? `
      <div style="margin-top:8px;">
        <textarea id="sellerMsg-${d._id}" rows="2"
                  placeholder="Your follow-up…"
                  style="width:100%;"></textarea><br/>
        <input type="file" id="sellerFile-${d._id}" /><br/>
        <button onclick="submitSellerFollowup('${d._id}')"
                style="margin-top:6px;padding:6px 12px;">
          Send Follow-Up
        </button>
      </div>
    ` : "";

    // 5️⃣ Put it all together
    const card = document.createElement("div");
    card.style = "border:1px solid #ccc; padding:12px; margin-bottom:14px; border-radius:6px;";
    card.innerHTML = `
      <p><strong>Order ID:</strong> ${d.order?._id || d.order}</p>
      <p><strong>Status:</strong> ${d.resolved ? "✅ Resolved" : "⏳ Open"}</p>
      ${historyHtml}
      ${followUpForm}
    `;
    container.appendChild(card);
  });
}

async function submitSellerFollowup(disputeId) {
  const msgEl  = document.getElementById(`sellerMsg-${disputeId}`);
  const fileEl = document.getElementById(`sellerFile-${disputeId}`);
  const message = msgEl.value.trim();
  if (!message) return alert("Please enter a response.");

  const form = new FormData();
  form.append("response", message);
  if (fileEl.files[0]) form.append("file", fileEl.files[0]);

  try {
    const res = await fetch(`/api/disputes/${disputeId}/reply`, {
      method: "PUT",
      headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
      body: form
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || "Failed to send response");
    }
    showToast("✅ Response sent");
    loadSellerDisputes();
  } catch (err) {
    console.error("Reply failed:", err);
    alert("❌ " + err.message);
  }
}


function openReplyModal(disputeId) {
  document.getElementById("currentDisputeId").value = disputeId;
  document.getElementById("replyModal").style.display = "block";
}

function closeReplyModal() {
  document.getElementById("replyModal").style.display = "none";
  document.getElementById("sellerResponse").value = "";
  document.getElementById("sellerResponseFile").value = "";
}

function submitReply() {
  const id      = document.getElementById("currentDisputeId").value;
  const message = document.getElementById("sellerResponse").value;
  const file    = document.getElementById("sellerResponseFile").files[0];
  const token   = localStorage.getItem("token");

  const form = new FormData();
  form.append("response", message);
  if (file) form.append("file", file);

  fetch(`/api/disputes/${id}/reply`, {
    method: "PUT",
    headers: { Authorization: `Bearer ${token}` },
    body: form
  })
  .then(r => r.json())
  .then(() => {
    closeReplyModal();
    loadSellerDisputes();
  })
  .catch(err => {
    console.error("Reply failed:", err);
    alert("Failed to send response.");
  });
}

async function loadOrders() {
  const res = await fetch('/api/orders/seller/orders', {
    headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
  });

  const data = await res.json();
  const container = document.getElementById('orderList');
  container.innerHTML = '';

  if (!Array.isArray(data) || data.length === 0) {
    container.innerHTML = '<p>No orders yet.</p>';
    return;
  }

  for (const order of data) {
    for (const item of order.products) {
      const product = item.product;
      if (!product || product.seller !== getUserId()) continue;

      const div = document.createElement('div');
      div.style.border = '1px solid #ccc';
      div.style.marginBottom = '10px';
      div.style.padding = '10px';

      const selectId = `status-${order._id}`;
      div.innerHTML = `
        <p><strong>Product:</strong> ${product.name}</p>
        <p><strong>Quantity:</strong> ${item.quantity}</p>
        <p><strong>Current Status:</strong> ${order.status}</p>
        <p><strong>Total Price:</strong> $${(product.price * item.quantity).toFixed(2)}</p>
        <label for="${selectId}"><strong>Update Status:</strong></label>
        <select id="${selectId}">
          <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
          <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
          <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
          <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
        </select>
        <button onclick="updateOrderStatus('${order._id}', '${selectId}')">Update</button>
      `;
      container.appendChild(div);
    }
  }
}

async function updateOrderStatus(orderId, selectId) {
  const newStatus = document.getElementById(selectId).value;

  const res = await fetch(`/api/orders/${orderId}/status`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + localStorage.getItem('token')
    },
    body: JSON.stringify({ status: newStatus })
  });

  if (res.ok) {
    alert('✅ Order status updated!');
    loadOrders();
  } else {
    const err = await res.json();
    alert('❌ Failed to update: ' + (err.error || 'Unknown error'));
  }
}

async function loadSellerBalance() {
  const res = await fetch('/api/users/me', {
    headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
  });
  const user = await res.json();
  document.getElementById('availableBalance').textContent = (user.balance || 0).toFixed(2);
  document.getElementById('pendingBalance').textContent = (user.pendingBalance || 0).toFixed(2);
}

function openWithdrawModal() {
  document.getElementById('withdrawModal').style.display = 'block';
}

function closeWithdrawModal() {
  document.getElementById('withdrawModal').style.display = 'none';
}

async function submitSellerResponse(disputeId, textId, fileId) {
  const message = document.getElementById(textId).value.trim();
  const fileInput = document.getElementById(fileId);
  const formData = new FormData();
  formData.append("message", message);
  if (fileInput.files.length > 0) {
    formData.append("proof", fileInput.files[0]);
  }

  const res = await fetch(`/api/disputes/respond/${disputeId}`, {
    method: "POST",
    headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
    body: formData
  });

  const data = await res.json();
  alert(data.success ? "Response submitted!" : data.error);
  loadSellerDisputes();
}

</script>

<div id="withdrawModal" style="display:none; position:fixed; top:25%; left:50%; transform:translateX(-50%);
  background:white; padding:25px; border-radius:8px; box-shadow:0 0 12px rgba(0,0,0,0.3); z-index:2000; width:320px;">
  <h3>Select Withdrawal Method</h3>
  <p><button disabled style="width:100%; padding:10px; margin:8px 0; background:#007bff; color:white; border:none; border-radius:6px;">💳 Credit/Debit Card (Coming Soon)</button></p>
  <p><button disabled style="width:100%; padding:10px; margin:8px 0; background:#28a745; color:white; border:none; border-radius:6px;">🏦 Bank Transfer (Coming Soon)</button></p>
  <button onclick="closeWithdrawModal()" style="margin-top:10px; padding:8px 14px; background:#dc3545; color:white; border:none; border-radius:5px;">Close</button>
</div>

<div id="replyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000;">
  <div style="background:white; padding:20px; max-width:500px; margin:100px auto; border-radius:8px; position:relative;">
    <h3>Respond to Dispute</h3>
    <textarea id="sellerResponse" placeholder="Your response..." style="width:100%; height:100px; margin-bottom:10px;"></textarea>
    <input type="file" id="sellerResponseFile" style="margin-bottom:10px;" />
    <div style="text-align:right;">
      <button onclick="submitReply()" style="background:#28a745; color:white; padding:8px 14px; border:none; border-radius:4px;">Submit</button>
      <button onclick="closeReplyModal()" style="background:#ccc; padding:8px 14px; border:none; border-radius:4px; margin-left:5px;">Cancel</button>
    </div>
    <input type="hidden" id="currentDisputeId" />
  </div>
</div>

</body>
</html>
