<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register - Cartify</title>
  <link rel="stylesheet" href="login.css" />
</head>
<body>
<div class="scroll-container">
 <div class="form-box">
  <div class="container">
    <form class="form" id="registerForm">
      <h2>Create an Account</h2>

      <!-- üë§ Role Selection -->
      <label>Role</label>
      <select name="role" id="role" required>
        <option value="">Select role</option>
        <option value="buyer">Buyer</option>
        <option value="seller">Seller</option>
        <option value="admin">Admin</option>
      </select>

      <!-- üë§ Name -->
      <div id="field-name">
        <label>Name</label>
        <input type="text" name="name" required />
      </div>

      <!-- üìß Email -->
      <div id="field-email">
        <label>Email</label>
        <input type="email" name="email" required />
      </div>

      <!-- üîê Password -->
      <div id="field-password">
        <label>Password</label>
        <input type="password" name="password" required />
      </div>

      <!-- üîë Admin Passkey -->
      <div id="admin-passkey" style="display: none;">
        <label>Admin Passkey</label>
        <input type="password" name="adminPasskey" placeholder="Enter admin passkey"/>
      </div>

      <!-- üë• Extended Fields -->
      <div id="extended-fields">
        <label>Phone Number</label>
        <input type="text" name="phone" />

        <label>Country</label>
        <select id="country" name="country">
          <option value="Canada">Canada</option>
          <option value="USA">United States</option>
          <option value="UK">United Kingdom</option>
          <option value="Other">Other (Type Below)</option>
        </select>

        <input type="text" id="otherCountry" placeholder="Enter your country" style="display:none;" />

        <label>State/Province</label>
        <select id="state" name="state">
          <option value="">Select a country first</option>
        </select>

        <label>City</label>
        <input type="text" name="city" />

        <label>Address Line 1</label>
        <input type="text" name="address1" />

        <label>Address Line 2</label>
        <input type="text" name="address2" />

        <label>Company Name (Optional)</label>
        <input type="text" name="companyName" />
      </div>

      <!-- ‚úÖ Success/Error Message -->
      <div id="message" style="margin: 10px 0; text-align: center;"></div>

      <button type="submit">Register</button>
      <p>Already have an account? <a href="login.html">Login here</a></p>
    </form>
   </div>
 </div>
</div>

<script>
  const roleSelect = document.getElementById('role');
  const adminPasskeyField = document.getElementById('admin-passkey');
  const extendedFields = document.getElementById('extended-fields');

  roleSelect.addEventListener('change', function () {
    const role = this.value;

    if (role === 'admin') {
      adminPasskeyField.style.display = 'block';
      extendedFields.style.display = 'none';
    } else if (role === 'buyer' || role === 'seller') {
      adminPasskeyField.style.display = 'none';
      extendedFields.style.display = 'block';
    } else {
      adminPasskeyField.style.display = 'none';
      extendedFields.style.display = 'none';
    }
  });

  const countryDropdown = document.getElementById('country');
  const otherCountryInput = document.getElementById('otherCountry');
  const stateDropdown = document.getElementById('state');

  const statesByCountry = {
    Canada: ["Ontario", "Quebec", "British Columbia", "Alberta", "Manitoba", "Saskatchewan", "Nova Scotia"],
    USA: ["California", "Texas", "New York", "Florida", "Illinois", "Pennsylvania", "Ohio"],
    UK: ["England", "Scotland", "Wales", "Northern Ireland"],
  };

  countryDropdown.addEventListener('change', function () {
    const selected = this.value;

    if (selected === 'Other') {
      otherCountryInput.style.display = 'block';
      stateDropdown.innerHTML = '<option value="">Enter state manually</option>';
    } else {
      otherCountryInput.style.display = 'none';
      const states = statesByCountry[selected] || [];
      stateDropdown.innerHTML = states.map(state => `<option value="${state}">${state}</option>`).join('');
    }
  });

  // ‚úÖ Replace country if "Other" is selected
  document.querySelector('form').addEventListener('submit', function () {
    const selected = countryDropdown.value;
    const otherCountryVal = otherCountryInput.value.trim();

    if (selected === 'Other' && otherCountryVal) {
      const option = document.createElement('option');
      option.value = otherCountryVal;
      option.text = otherCountryVal;
      option.selected = true;

      const otherOption = countryDropdown.querySelector('option[value="Other"]');
      if (otherOption) {
        countryDropdown.removeChild(otherOption);
      }

      countryDropdown.appendChild(option);
    }
  });

  // ‚úÖ Handle submission via fetch()
  document.getElementById("registerForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const messageBox = document.getElementById("message");

    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch("/api/users/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (res.ok) {
        messageBox.style.color = "green";
        messageBox.innerHTML = `‚úÖ Registration successful! <a href="login.html">Log in</a>`;
        form.reset();
      } else {
        messageBox.style.color = "red";
        messageBox.textContent = "‚ùå " + (result.error || "Registration failed.");
      }
    } catch (err) {
      console.error(err);
      messageBox.style.color = "red";
      messageBox.textContent = "‚ùå Server error. Please try again.";
    }
  });
</script>
</body>
</html>
